
<script type="text/javascript" src="../_static/pattern_calculator/pattern_calculator.js"></script>
<script>

    function sanitize_pattern_params(pattern) {

        // sanitize tie_off
        if (pattern.tie_off_type == undefined){
            pattern.tie_off_type = "webbing"
        }

        if (["webbing", "grommets"].includes(pattern.tie_off_type) == false) {
            assert(`tie_off_type was set to an invalid value: ${pattern.tie_off_type}`)
            pattern.tie_off_type = "webbing"
        }

        // Sanitize tie-off counts
        default_tie_off_count = 5
        if ([NaN, undefined].includes(pattern.tie_off_count_length)) {
            pattern.tie_off_count_length = default_tie_off_count
        }
        if ([NaN, undefined].includes(pattern.tie_off_count_width)) {
            pattern.tie_off_count_width = default_tie_off_count
        }

        if (pattern.tie_off_count_length < 2) {
            pattern.tie_off_count_length = 2
        }

        if (pattern.tie_off_count_width < 2) {
            pattern.tie_off_count_width = 2
        }

        // sanitize tarp dimentsions
        if ([NaN, undefined].includes(pattern.tarp_length_mm)) {
            pattern.tarp_length_mm = 3000
        }
        if ([NaN, undefined].includes(pattern.tarp_width_mm)) {
            pattern.tarp_width_mm = 3000
        }
        if (pattern.tarp_length_mm < 50 ){
            pattern.tarp_length_mm = 50
        }
        if (pattern.tarp_width_mm < 50 ){
            pattern.tarp_width_mm = 50
        }
    return pattern        
    }

    function draw_sketch(pattern) {
        
 
        let svg = document.querySelector("svg#main_panel")
        let canvas = document.querySelector("g#canvas")

        // this is used to clear all child elements, and produce a clean canvas
        // we need to clear it so old versions of the sketch aren't left behid
        // when live-updating the preview.
        canvas.replaceChildren()

        let panel_section_count = Math.ceil(pattern.tarp_width_mm / FABRIC_WIDTH_MM)
        let panel_section_width_mm = pattern.tarp_width_mm / panel_section_count
        console.log("panel count: " + panel_section_count)
        console.log("panel_section_width: " + panel_section_width_mm + "mm")
        let main_panel_outline = fabric_rect(
            canvas,
            0,
            0,
            pattern.tarp_width_mm,
            pattern.tarp_length_mm,
        )

        // So, the.viewbox attribute is a [x1,y1, x2,y2] array for the bounding box corners
        // but the setAttribute wants it in "x1 y1 x2 y2" space-delimidet string format.
        // hence the join(" ")
        // We are padding the main panel viewbox just enough that all the tie-out
        // points will be visible in the final image
        svg.setAttribute("viewBox", pad_svg_viewbox(main_panel_outline.viewbox, 200).join(" "))
        console.log(svg)
        
        // Draw all the fabric section that are used to make up the 
        // main panel of the tarp 
        console.log("drawing main panel sections")
        for (let section = 0; section < panel_section_count; section++) {
            let section_outline = fabric_rect(
                canvas,
                x = panel_section_width_mm * section,
                y = 0,
                width_mm = panel_section_width_mm,
                height_mm = pattern.tarp_length_mm,
                0,
                0,
                "m05_summer",
                
            )
        }

        for (let tie_off_idx = 0; tie_off_idx < pattern.tie_off_count_width; tie_off_idx++) {
            // we use tie_off_count_width -1 since for example 5 tie-offs only have 4 spaces between them
            tie_off_spacing_mm = pattern.tarp_width_mm / (pattern.tie_off_count_width -1)
            reinforcement_size = 100
            tie_off = fabric_rect(
                canvas,
                x = tie_off_idx * tie_off_spacing_mm - reinforcement_size/2,
                y = 0 - reinforcement_size/2,
                width_mm= reinforcement_size,
                height_mm = reinforcement_size,
            )
            tie_off = fabric_rect(
                canvas,
                x = tie_off_idx * tie_off_spacing_mm - reinforcement_size/2,
                y = pattern.tarp_length_mm - reinforcement_size/2,
                width_mm= reinforcement_size,
                height_mm = reinforcement_size,
            )
        }

        for (let tie_off_idx = 1; tie_off_idx < pattern.tie_off_count_length -1;  tie_off_idx++) {
            // we use tie_off_count_width -1 since for example 5 tie-offs only have 4 spaces between them
            tie_off_spacing_mm = pattern.tarp_length_mm / (pattern.tie_off_count_length -1)
            tie_off = fabric_rect(
                canvas,
                x = 0 - reinforcement_size/2,
                y = tie_off_idx * tie_off_spacing_mm - reinforcement_size/2,
                width_mm = reinforcement_size,
                height_mm = reinforcement_size,
            )
            tie_off = fabric_rect(
                canvas,
                x = pattern.tarp_width_mm - reinforcement_size/2,
                y = tie_off_idx * tie_off_spacing_mm - reinforcement_size/2,
                width_mm= reinforcement_size,
                height_mm = reinforcement_size,
            )
        }
    }


    function get_pattern_derived_data(pattern) {
       /////// Calculation of the total material cost //////////
        const cost_per_tie_off = {
            "webbing": 1.5,
            "grommets": 2,
        }
        const fabric_cost_per_meter = {
            "m05_summer": 14.9,
            "m05_winter": 14.9,
            "PU Nylon 70gm2, green": 4.9,
        }
        const seam_seal_cost_per_meter = 0.8 
        const webbing_cost_per_meter = {
            "savotta_irr": 1.9,
            "olive_green": 0.4,
        }

        spec = {}
        spec.materials = {}
        spec.materials.webbing = "savotta_irr"
        spec.materials.main_fabric = "m05_summer"

        spec.pattern = pattern
        spec.total_material_cost = 0

        let panel_section_count = Math.ceil(pattern.tarp_width_mm / FABRIC_WIDTH_MM)

        // material cost for the main fabric
        
        spec.main_fabric = {}
        spec.main_fabric.unit = "meter"
        spec.main_fabric.quantity = pattern.tarp_length_mm / METER * panel_section_count
        spec.main_fabric.total_cost = spec.main_fabric.quantity * fabric_cost_per_meter[spec.materials.main_fabric]
        spec.total_material_cost += spec.main_fabric.total_cost
        console.log(spec)
        
        spec.tie_out = {}
        spec.tie_out.unit = "pcs"
        spec.tie_out.quantity = (pattern.tie_off_count_width*2) + (pattern.tie_off_count_length - 2)*2
        console.log(spec)

        spec.tie_out.webbing = {}
        spec.tie_out.webbing.unit = "meter"
        spec.tie_out.webbing.quantity = spec.tie_out.quantity * 0.2
        spec.tie_out.webbing.total_cost = spec.tie_out.quantity * 0.2 * webbing_cost_per_meter[spec.materials.webbing]
        

        spec.tie_out.total_cost = spec.tie_out.quantity * cost_per_tie_off[pattern.tie_off_type]
        spec.total_material_cost += spec.tie_out.total_cost
        console.log(spec)
        
        
        spec.seam_seal = {}
        spec.seam_seal.unit = "meter"
        spec.seam_seal.quantity = (panel_section_count - 1) * (pattern.tarp_length_mm / 1000)
        spec.seam_seal.total_cost = seam_seal_cost_per_meter * spec.seam_seal.quantity
        spec.total_material_cost += spec.seam_seal.total_cost
        console.log(spec)

        assert(![NaN, undefined, null].includes(spec.total_material_cost), "programming error, cost is NaN, undefined or null. Check input type sanitization")
       
        return spec


    }

    function draw_pattern_data(pattern){

        spec = get_pattern_derived_data(pattern)
        spec_pre = document.querySelector("pre#specification_data")
        spec_pre.innerHTML = JSON.stringify(spec, null, 4)
    
    }

    function update_page() {
        pattern = sanitize_pattern_params(get_params_from_form())
        // resubmit_form()
        draw_sketch(pattern);
        draw_pattern_data(pattern)
        set_pattern_params_to_url(pattern)
    }


    </script>
    <form action="" name="pattern_form" id="pattern_form" onchange="update_page()">
        <fieldset>
            <legend>Set the specifications for your tarp</legend>
            
            <label for="tie_off_type">tie_off_type</label><br>
            <input type="select" name="tie_off_type"  id="tie_off_type" list="tie_off_type_list"><br>
            <datalist id="tie_off_type_list">
                <option value="webbing">
                <option value="grommets">
            </datalist>          
                        
            <label for="tie_off_count_width" >Tie-off points widthwise</label><br>    
            <input type="number" name="tie_off_count_width"   id="tie_off_count_width" min="2"> pcs<br />

            <label for="tie_off_count_length">Tie-off points lengthwise</label><br>   
            <input type="number" name="tie_off_count_length"  id="tie_off_count_length" min="2" > pcs<br />
                        
            <label for="tarp_width_mm">Tarp width</label><br>    <input type="number" name="tarp_width_mm"  id="tarp_width_mm"   min="50" step="50"> mm<br />

            <label for="tarp_length_mm">Tarp length</label><br>  <input type="number" name="tarp_length_mm" id="tarp_length_mm"  min="50" step="50"> mm<br />
        </fieldset>
        <input type="submit">
    </form>

    <div id="content">
        <h2>Tarp design sketch</h2>    
            <svg xmlns="http://www.w3.org/2000/svg"  height="500" id="main_panel">
                <defs>
                    <pattern id="m05_summer" patternUnits="userSpaceOnUse" patternContentUnits="objectBoundingBox" viewbox="0 0 1500 1300" width="1500" height="1300">
                      <image href="../_static/m05-summer-crop.svg" x="0" y="0" width="1500" height="1300" />
                    </pattern>
                  </defs>
                  <g id="canvas"></g>
            </svg>


        <h2>Specifications</h2>
        <p>The data in this section specifies all the features of the tarp, a break-down material costs, and well as the sum total material cost.
            The data is automatically updated as the options are changed. </p>
        <pre id="specification_data"></pre>

    </div>

    <script>
        pattern = get_pattern_params_from_url()
        pattern = sanitize_pattern_params(pattern)
        set_pattern_params_to_form(pattern)
        set_pattern_params_to_url(pattern)
        update_page()
    </script>

<!DOCTYPE html>
<html>
<head>
    <style>
        /* body{
            font-family: monospace;
        }
        form{
            display: block;
            float: left;
            width: 20%
        }
        #content {
            display: block;
            float: left;
            width: 50%;
            padding-left: 5%;
        }
         */
    </style>
    <script type="text/javascript" src="./pattern_calculator.js"></script>
    <script>

        function draw_sketch() {
            

            let pattern = get_pattern_params();

            if (["webbing", "grommets"].includes(pattern.tie_off_type) == false) {
                alert("Tie-off type has to be 'webbing' or 'grommets'")
                document.getElementById("tie_off_type").value = "webbing"
                resubmit_form()
            }

            if (pattern.tie_off_count_length < 2) {
                alert('tie-off count cannot be less than 2 per side')
                document.getElementById("tie_off_count_length").value = 2
                resubmit_form()
            }

            if (pattern.tie_off_count_width < 2) {
                alert('tie-off count cannot be less than 2 per side')
                document.getElementById("tie_off_count_length").value = 2
                resubmit_form()
            }

            assert(["webbing", "grommets"].includes(pattern.tie_off_type), "Tie-off type not recognized. Shall be 'webbing' or 'grommets'")
            assert(pattern.tie_off_count_length >= 2, "The number of tie-off can't be less than 2 per side")
            assert(pattern.tie_off_count_width >= 2, "The number of tie-off can't be less than 2 per side")



            let svg = document.querySelector("svg#main_panel")

            let fabric_width_mm = 1500

            let panel_section_count = Math.ceil(pattern.tarp_width_mm / fabric_width_mm)
            let panel_section_width_mm = pattern.tarp_width_mm / panel_section_count
            console.log("panel count: " + panel_section_count)
            console.log("panel_section_width: " + panel_section_width_mm + "mm")
            let main_panel_outline = fabric_rect(
                svg,
                0,
                0,
                pattern.tarp_width_mm,
                pattern.tarp_length_mm,
            )

            // So, the.viewbox attribute is a [x1,y1, x2,y2] array for the bounding box corners
            // but the setAttribute wants it in "x1 y1 x2 y2" space-delimidet string format.
            // hence the join(" ")
            // We are padding the main panel viewbox just enough that all the tie-out
            // points will be visible in the final image
            svg.setAttribute("viewBox", pad_svg_viewbox(main_panel_outline.viewbox, 200).join(" "))
            console.log(svg)


            
            // Draw all the fabric section that are used to make up the 
            // main panel of the tarp 
            console.log("drawing main panel sections")
            for (let section = 0; section < panel_section_count; section++) {
                fabric_rect(
                    svg,
                    x = panel_section_width_mm * section,
                    y = 0,
                    width = panel_section_width_mm,
                    height = pattern.tarp_length_mm,
                )
            }



            // Draw tie-off points ////////////
            console.log("drawing tie-off points")
            

            for (let tie_off_idx = 0; tie_off_idx < pattern.tie_off_count_width; tie_off_idx++) {
                console.log("tie-off index: " + tie_off_idx)
                // we use tie_off_count_width -1 since for example 5 tie-offs only have 4 spaces between them
                tie_off_spacing_mm = pattern.tarp_width_mm / (pattern.tie_off_count_width -1)
                reinforcement_size = 100
                fabric_rect(
                    svg,
                    x = tie_off_idx * tie_off_spacing_mm - reinforcement_size/2,
                    y = 0 - reinforcement_size/2,
                    width_mm= reinforcement_size,
                    height_mm = reinforcement_size,
                )
                fabric_rect(
                    svg,
                    x = tie_off_idx * tie_off_spacing_mm - reinforcement_size/2,
                    y = pattern.tarp_length_mm - reinforcement_size/2,
                    width_mm= reinforcement_size,
                    height_mm = reinforcement_size,
                )
                

            }


            for (let tie_off_idx = 1; tie_off_idx < pattern.tie_off_count_length -1;  tie_off_idx++) {
                console.log("length tie-off index: " + tie_off_idx)
                // we use tie_off_count_width -1 since for example 5 tie-offs only have 4 spaces between them
                tie_off_spacing_mm = pattern.tarp_length_mm / (pattern.tie_off_count_length -1)
                fabric_rect(
                    svg,
                    x = 0 - reinforcement_size/2,
                    y = tie_off_idx * tie_off_spacing_mm - reinforcement_size/2,
                    width_mm = reinforcement_size,
                    height_mm = reinforcement_size,
                )
                fabric_rect(
                    svg,
                    x = pattern.tarp_width_mm - reinforcement_size/2,
                    y = tie_off_idx * tie_off_spacing_mm - reinforcement_size/2,
                    width_mm= reinforcement_size,
                    height_mm = reinforcement_size,
                )
            }
            

            /////// Calculation of the total material cost //////////
            const cost_per_tie_off = {
                "webbing": 1.5,
                "grommets": 2
            }
            const fabric_cost_per_meter = 14.9

            let total_material_cost = 0
            
            // material cost for the main fabric
            total_material_cost += pattern.tarp_length_mm / METER * fabric_cost_per_meter * panel_section_count

            // material cost for the tie-offs
            total_tie_off_count = pattern.tie_off_count_width * 2
            // -2 since the corners are accounted for in the widthwise calculation
            total_tie_off_count += (pattern.tie_off_count_length - 2) * 2 
            total_material_cost += total_tie_off_count * cost_per_tie_off[pattern.tie_off_type]
            console.log("total material cost: " + total_material_cost)
            assert(total_material_cost != NaN, "programming error, cost is NaN")
            // material cost for seam tape

            
            spec = pattern
            spec["total_tie_off_count"] = total_tie_off_count
            spec["material_cost"] = total_material_cost
            spec["product price"] = Math.ceil(total_material_cost * 1.5)
            spec_pre = document.querySelector("pre#specification_data")
            spec_pre.innerHTML = JSON.stringify(pattern, null, 4)
        
        }

        function resubmit_form() {
            document.getElementById('pattern_form').submit()
            return true
        }
    
        </script>
</head>
<body>




    <form action="" id="pattern_form" onchange="resubmit_form()">
        <!-- <fieldset>
            <legend>Tie-off point type</legend>

            <input type="radio" name="tie_off_type" id="webbing_loops" value="webbing loops">
            <label for="webbing_loops">Webbing loops</label>
            <br>
            <input type="radio" name="tie_off_type" id="grommets"      value="grommets">
            <label for="grommets">Grommets</label>
            

        </fieldset> -->
        <fieldset>

            <legend>Tarp features</legend>
            <label for="tie_off_type">tie_off_type</label><br>
            <input type="select" name="tie_off_type"  id="tie_off_type" list="tie_off_type_list"><br>
            <datalist id="tie_off_type_list">
                <option value="webbing">
                <option value="grommets">
            </datalist>
                        
                        
            <label for="tie_off_count_width" >Tie-off points widthwise</label><br>    
            <input type="number" name="tie_off_count_width"   id="tie_off_count_width"  value="5"> pcs<br />
            <label for="tie_off_count_length">Tie-off points lengthwise</label><br>   
            <input type="number" name="tie_off_count_length"  id="tie_off_count_length" value="5"> pcs<br />
                        
        </fieldset>
        <fieldset>
            <legend>Tarp Dimensions</legend>
            <label for="tarp_width_mm">Tarp width</label><br>    <input type="number" name="tarp_width_mm"  id="tarp_width_mm"  value="2500" step="50"> mm<br />
            <label for="tarp_length_mm">Tarp length</label><br>  <input type="number" name="tarp_length_mm" id="tarp_length_mm" value="2500" step="50"> mm<br />
        </fieldset>
        <input type="submit">
    </form>

    <div id="content">
        <h2>Tarp design sketch</h2>    
            <svg xmlns="http://www.w3.org/2000/svg"  height="500" id="main_panel"></svg>
        <h2>Width of the tarp</h2>
        <p>
            The number of sections of fabric used for the tarp depend on the width of the tarp. 
            Fabric comes in 1.5m wide rolls. So for every 1.5 meters of with, the tarp consturction adds
            one more section of fabric. This means that the meterials needed for a 3meter wide tarp is much less than
            what is needed for a 3.2 meter tarp. As that extra 20 cm requires adding an entire 3rd section of fabric
        </p>
        <h2>The number of tie-off points</h2>
        <p>The tie-off points will be evenly spaced along each side of the tarp. With tie-offs in the corners, there is always at least two tie-off on each edge.</p>
        <h2>Ordering information</h2>
        <p>To order a tarp just like the one you like, please copy-paste include the below information in your order</p>
        
        <fieldset>
            <legend>Tarp sepcification</legend>
            <pre id="specification_data"></pre>
        </fieldset>

    </div>

    <script>
        update_params_to_form()
        draw_sketch()
    </script>
</body>
</html>